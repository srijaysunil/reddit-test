<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Reddit Scheduler</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 900px; margin: 30px auto; padding: 0 16px; }
        h1 { margin-bottom: 8px; }
        .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin-bottom: 20px; }
        label { display:block; margin-top: 10px; font-weight: 600; }
        input[type="text"], input[type="url"], input[type="datetime-local"], textarea, select { width: 100%; padding: 8px; border:1px solid #ccc; border-radius:8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; vertical-align: top; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .muted { color: #666; font-size: 0.9em; }
        .status { font-weight: 600; }
        .ok { color: #0a7b34; }
        .pend { color: #915100; }
        .err { color: #b00020; white-space: pre-wrap; }
        .btn { display: inline-block; padding: 8px 12px; border-radius: 8px; text-decoration: none; cursor: pointer; border: none; }
        .btn-primary { background: #2962ff; color: white; }
        .btn-danger { background: #e53935; color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; }
        .flash { background: #f0f7ff; border: 1px solid #cfe2ff; padding: 10px 12px; border-radius: 8px; margin-bottom: 12px; }
        #flair_select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
        .loading { color: #666; font-style: italic; }
        .destination-toggle { display: flex; gap: 16px; margin-top: 10px; }
        .destination-toggle label { display: inline-flex; align-items: center; gap: 6px; margin-top: 0; font-weight: normal; }
        input[type="radio"] { margin: 0; }
    </style>
    <script>
        function onPostTypeChange() {
            var type = document.getElementById("post_type").value;
            var linkRow = document.getElementById("linkRow");
            var textRow = document.getElementById("textRow");
            var imageRow = document.getElementById("imageRow");
            linkRow.style.display = (type === "link") ? "block" : "none";
            textRow.style.display = (type === "text") ? "block" : "none";
            imageRow.style.display = (type === "image") ? "block" : "none";
        }

        function onDestinationChange() {
            const destination = document.querySelector('input[name="destination_type"]:checked').value;
            const subredditGroup = document.getElementById('subredditGroup');
            const flairGroup = document.getElementById('flairGroup');
            
            if (destination === 'profile') {
                subredditGroup.style.display = 'none';
                flairGroup.style.display = 'none';
            } else {
                subredditGroup.style.display = 'block';
                flairGroup.style.display = 'block';
                
                // Update flairs when switching back to subreddit mode
                const subredditInput = document.querySelector('input[name="subreddit"]');
                if (subredditInput.value) {
                    updateFlairs(subredditInput.value);
                }
            }
        }

        function updateFlairs(subreddit) {
            if (!subreddit) {
                document.getElementById('flair_select').innerHTML = '<option value="">No flair</option>';
                return;
            }
            
            // Show loading state
            const select = document.getElementById('flair_select');
            select.innerHTML = '<option value="" class="loading">Loading flairs...</option>';
            
            fetch(`/get_flairs/${subreddit}`)
                .then(response => response.json())
                .then(data => {
                    select.innerHTML = '<option value="">No flair</option>';
                    
                    if (data.error) {
                        console.error('Error fetching flairs:', data.error);
                        select.innerHTML = '<option value="">Error loading flairs</option>';
                        return;
                    }
                    
                    if (data.flairs && data.flairs.length > 0) {
                        data.flairs.forEach(flair => {
                            const option = document.createElement('option');
                            option.value = flair.id;
                            option.textContent = flair.text;
                            option.dataset.text = flair.text;
                            select.appendChild(option);
                        });
                    } else {
                        select.innerHTML = '<option value="">No flairs available</option>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    select.innerHTML = '<option value="">Error loading flairs</option>';
                });
        }

        function storeFlairText() {
            const select = document.getElementById('flair_select');
            const selectedOption = select.options[select.selectedIndex];
            document.getElementById('flair_text').value = selectedOption.dataset.text || '';
        }

        function setDefaultDateTime() {
            // Set default time to current time + 1 hour
            const now = new Date();
            now.setHours(now.getHours() + 1);
            now.setMinutes(0);
            now.setSeconds(0);
            
            // Format for datetime-local input (YYYY-MM-DDTHH:MM)
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const datetimeInput = document.getElementById('post_time');
            datetimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        window.addEventListener("DOMContentLoaded", function() {
            onPostTypeChange();
            onDestinationChange();
            setDefaultDateTime();
            
            // Initialize flairs on page load if subreddit is pre-filled and destination is subreddit
            const subredditInput = document.querySelector('input[name="subreddit"]');
            const destination = document.querySelector('input[name="destination_type"]:checked').value;
            
            if (destination === 'subreddit' && subredditInput.value) {
                updateFlairs(subredditInput.value);
            }
            
            // Update flairs when subreddit changes (only if destination is subreddit)
            subredditInput.addEventListener('input', function(e) {
                const destination = document.querySelector('input[name="destination_type"]:checked').value;
                if (destination === 'subreddit') {
                    updateFlairs(e.target.value.trim());
                }
            });

            // Store flair text when selection changes
            document.getElementById('flair_select').addEventListener('change', storeFlairText);

            // Handle destination change
            document.querySelectorAll('input[name="destination_type"]').forEach(radio => {
                radio.addEventListener('change', onDestinationChange);
            });
        });
    </script>
</head>
<body>
    <h1>Reddit Scheduler</h1>
    <div class="muted">Times are interpreted in your app timezone (<strong>{{ app_tz }}</strong>) and stored/executed in UTC.</div>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash">{{ messages[0] }}</div>
      {% endif %}
    {% endwith %}

    <div class="card">
        <form method="POST" enctype="multipart/form-data">
            <div>
                <label>Post Destination</label>
                <div class="destination-toggle">
                    <label>
                        <input type="radio" name="destination_type" value="subreddit" checked> Post to Subreddit
                    </label>
                    <label>
                        <input type="radio" name="destination_type" value="profile"> Post to My Profile
                    </label>
                </div>
            </div>

            <div class="row">
                <div id="subredditGroup">
                    <label>Subreddit (without r/)</label>
                    <input type="text" name="subreddit" placeholder="learnpython" />
                </div>
                <div>
                    <label>Title</label>
                    <input type="text" name="title" placeholder="Check out this resource" required />
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Post Type</label>
                    <select name="post_type" id="post_type" onchange="onPostTypeChange()" required>
                        <option value="link">Link</option>
                        <option value="text">Text</option>
                        <option value="image">Image</option>
                    </select>
                </div>
                <div>
                    <label>Post Time</label>
                    <input type="datetime-local" name="post_time" id="post_time" required />
                </div>
            </div>

            <div class="row" id="flairGroup">
                <div>
                    <label>Flair (Optional)</label>
                    <select name="flair_id" id="flair_select">
                        <option value="">No flair</option>
                        {% for flair in flairs %}
                            <option value="{{ flair.id }}" data-text="{{ flair.text }}">{{ flair.text }}</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="flair_text" id="flair_text">
                </div>
            </div>

            <div id="linkRow">
                <label>URL</label>
                <input type="url" name="content" placeholder="https://example.com" />
            </div>
            <div id="textRow" style="display:none">
                <label>Text</label>
                <textarea name="content" rows="6" placeholder="Write your post text here..."></textarea>
            </div>
            <div id="imageRow" style="display:none">
                <label>Upload Image</label>
                <input type="file" name="image_file" accept=".png,.jpg,.jpeg" />
                <div class="muted">Or provide a path inside the container (advanced):</div>
                <input type="text" name="content" placeholder="/data/uploads/myimage.jpg" />
            </div>

            <br/>
            <button class="btn btn-primary" type="submit">Schedule</button>
        </form>
    </div>

    <div class="card">
        <h2>Scheduled Posts</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Destination</th>
                    <th>Subreddit</th>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Content</th>
                    <th>Flair</th>
                    <th>Post Time (UTC)</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for p in posts %}
                <tr>
                    <td>{{ p[0] }}</td>
                    <td>
                        {% if p[10] == 'profile' %}
                            Profile
                        {% else %}
                            Subreddit
                        {% endif %}
                    </td>
                    <td>
                        {% if p[10] == 'profile' %}
                            (Profile)
                        {% else %}
                            r/{{ p[1] }}
                        {% endif %}
                    </td>
                    <td>{{ p[2] }}</td>
                    <td>{{ p[3] }}</td>
                    <td>
                        {% if p[3] == "link" %}
                            <a href="{{ p[4] }}" target="_blank">{{ p[4] }}</a>
                        {% else %}
                            {{ p[4] }}
                        {% endif %}
                    </td>
                    <td>{{ p[9] if p[9] else 'None' }}</td>
                    <td>{{ p[5] }}</td>
                    <td class="status">
                        {% if p[6] == 1 %}
                            <span class="ok">✅ Posted</span>
                        {% else %}
                            <span class="pend">⏳ Scheduled</span>
                        {% endif %}
                        {% if p[7] %}
                            <div class="err">Error: {{ p[7] }}</div>
                        {% endif %}
                    </td>
                    <td>
                        <form method="POST" action="/delete/{{ p[0] }}">
                            <button class="btn btn-danger" type="submit">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>